var accountMetadata,settings,ss,currentDWD,currentWFAACL,currentStudentID,currentAcctURL,currentAcctData,currentAcctID,TIMEOUT=3E4,TRANSITION_TIME=.4,FADE_TIME=75,ERR_FADE_TIME=175,VERSION="1.9.1",DEFAULT_SETTINGS={allowDiag:!0,allowPush:!0,pushInterval:3600,version:VERSION},IOS_BTN_FADE_TIME=100;ons.forcePlatformStyling("ios");
$(document).ready(function(){"windows"===cordova.platformId&&(window.onerror=function(){return!0});$.ajaxSetup({timeout:TIMEOUT});ons.ready(function(){$("#iOSBackBtn").on("click.goBack",goBack);$("#settingsBtn").one("click",function(){$.getScript("settings/settings.min.js",function(){$("#settingsBtn").click(goToSettings);goToSettings()})});$("#acctBtn").click(openAcctPopover);ss=new cordova.plugins.SecureStorage(function(){console.info("Secure storage init complete!");ss.get(function(a){accountMetadata=
JSON.parse(a).accounts;console.info("Successfully retrieved metadata!");loadAcctList();document.addEventListener("resume",onResume,!1);AppRate.preferences.displayAppName="ScoreScope";AppRate.preferences.useLanguage="en";AppRate.preferences.storeAppURL={ios:"com.albertzhang.scorescope",android:"market://details?id=com.albertzhang.scorescope",windows:"ms-windows-store://pdp/?ProductId=9NBLGGH515N6"};AppRate.promptForRating(!1)},function(a){console.error(a);console.warn("Error in initialization process...making user log in again!");
ss.remove(function(){window.location.replace("accounts/firstRun.html")},function(a){console.error(a)},"accountMetadata")},"accountMetadata");ss.get(function(a){settings=JSON.parse(a);console.info("Successfully retrieved settings!");if("undefined"===typeof settings.version||settings.version<VERSION)console.info("Settings are out of date! Upgrading to "+VERSION),settings=$.extend(DEFAULT_SETTINGS,settings),ss.set(function(a){console.info("Successfully upgraded "+a+" to "+VERSION)},function(a){console.warn("Failed to upgrade settings! Error: "+
a)},"settings",JSON.stringify(settings))},function(a){console.warn(a);console.warn("Could not retrieve settings...resetting to defaults");saveSettings(DEFAULT_SETTINGS)},"settings")},function(a){console.error("Error: "+a);displayErrorPage("mainPageErrMsgDiv","Oh No!","Failed to initialize secure storage. Please try again later.","ErrorTriangle",null)},"scorescope")})});
function goBack(){if("undefined"!==typeof settingsNavi&&"mainSettings"!==settingsNavi.topPage.name)settingsNavi.popPage({animation:"slide",animationOptions:{duration:TRANSITION_TIME}}),$("#title").text("Settings");else{switch(navi.pages[navi.pages.length-2].name.toLowerCase()){case "mainpage":$("#iOSBackBtn").fadeOut(IOS_BTN_FADE_TIME);$(".right").fadeIn(FADE_TIME);$("#title").text("Gradebook");break;case "accounts/accountManager.html":$("#title").text("Accounts");break;case "settings/settings.html":$("#title").text("Settings");
break;default:console.warn("Received incorrect navi topPage name!")}navi.popPage({animation:"slide",animationOptions:{duration:TRANSITION_TIME}})}}function onRefreshClick(){onResume()}
function onResume(){$("#title").text("Gradebook");$("#saveBtn").hide();var a=$("#iOSBackBtn");a.off("click.editorGoBack");a.on("click.goBack",goBack);a.hide();$("#goalDialog").hide();$("#title").text("Gradebook");navi.resetToPage("mainPage",{animation:"lift",animationOptions:{duration:TRANSITION_TIME}}).then(function(){loadAcctList(currentAcctID)})}
function saveSettings(a){ss.set(function(a){console.info("Successfully updated "+a)},function(a){alertMsg("Failed to save settings. Please try again.","Error");console.error("Failed to save settings. Error: "+a)},"settings",JSON.stringify("undefined"===typeof a?settings:a))}
function saveAcctMetadata(a,d){ss.set(function(a){console.info("Successfully updated "+a)},function(a){alertMsg("Failed to save account metadata. Please try again.","Error");console.error("Failed to save account metadata. Error: "+a)},"accountMetadata",JSON.stringify({accounts:a?a:accountMetadata}));d&&d()}
function goToSettings(){$("#iOSBackBtn").fadeIn(IOS_BTN_FADE_TIME);"settings/settings.html"===navi.topPage.name?"mainSettings"!==settingsNavi.topPage.name?settingsNavi.popPage().then(function(){$("#title").text("Settings")}):($(settingsNavi).fadeOut(FADE_TIME),$(settingsNavi).fadeIn(FADE_TIME)):(navi.resetToPage("settings/settings.html",{animation:"slide",animationOptions:{duration:TRANSITION_TIME}}).then(function(){navi.insertPage(0,"mainPage").then(function(){loadAcct(currentAcctData)})}),$("#title").text("Settings"))}
function openAcctPopover(){pop.show("#acctBtn")}function goToAcctMgr(){$("#iOSBackBtn").fadeIn(IOS_BTN_FADE_TIME);pop.hide();"accounts/accountManager.html"===navi.topPage.name?(loadAccountManager(),pop.hide()):(navi.resetToPage("accounts/accountManager.html",{animation:"slide",animationOptions:{duration:TRANSITION_TIME}}).then(function(){loadAccountManager();navi.insertPage(0,"mainPage").then(function(){loadAcct(currentAcctData)})}),$("#title").text("Accounts"))}
function alertMsg(a,d,b){ons.notification.alert({title:d,message:a,callback:b})}
function promptForGoal(){var a,d;"ios"===ons.platform._renderPlatform?(a=$("#goalInputIOS")[0],d=$("#failingInputIOS")[0]):(a=$("#goalInput")[0],d=$("#failingInput")[0]);$("#goalCancelBtn").one("click",function(){$("#goal").off("click").one("click",promptForGoal);goalDialog.hide()});$("#goalOKBtn").one("click",function(){if(isNumber(a.value)&&isNumber(d.value)){var b=Math.ceil(a.value),c=Math.ceil(d.value);if(b<c)var e=b,b=c,c=e;b===c&&c--;accountMetadata[currentAcctID].goal=b;accountMetadata[currentAcctID].failing=
c}else accountMetadata[currentAcctID].goal=returnUndefined(),accountMetadata[currentAcctID].failing=returnUndefined();goalDialog.hide();saveAcctMetadata(null,onRefreshClick)});goalDialog.show()}
function displayErrorPage(a,d,b,c,e){$(a+" > .errorTitle").text(d);$(a+" > .errorDetails").text(b);d=$(a+" > .errorRetryBtn");d.hide();"function"===typeof e&&(d.show(),d.unbind("click").on("click",e));c&&$(a+" > .errorIcon").attr("src","lib/img/"+c+".svg");$.when($(".loadingCircle").fadeOut(ERR_FADE_TIME)).then(function(){$(a+".errorMsgDiv").fadeIn(ERR_FADE_TIME)})}function isNumber(a){return"undefined"!==typeof a&&!isNaN(parseFloat(a))&&isFinite(a)}
function ensureRange(a,d,b){return Math.min(Math.max(a,d),b)}function returnUndefined(){}function colorFromGrade(a){a=function(a,b,c){if(0==b)c=b=a=c;else{var e=function(a,d,b){0>b&&(b+=1);1<b&&--b;return b<1/6?a+6*(d-a)*b:.5>b?d:b<2/3?a+(d-a)*(2/3-b)*6:a},g=.5>c?c*(1+b):c+b-c*b,f=2*c-g;c=e(f,g,a+1/3);b=e(f,g,a);a=e(f,g,a-1/3)}return[Math.floor(255*c),Math.floor(255*b),Math.floor(255*a)]}(1.2*a/360,.7,.6);return"rgb("+a[0]+","+a[1]+","+a[2]+")"}
function lightenColor(a,d){var b=parseInt(a.slice(1),16),c=0>d?0:255,e=0>d?-1*d:d,g=b>>16,f=b>>8&255,b=b&255;return"#"+(16777216+65536*(Math.round((c-g)*e)+g)+256*(Math.round((c-f)*e)+f)+(Math.round((c-b)*e)+b)).toString(16).slice(1)}
function loadAcctList(a){var d=$("#menuList");d.empty();d.append("<ons-list-header>Accounts</ons-list-header>");$.each(accountMetadata,function(a,c){var e=$('<ons-list-item tappable modifier="ripple longdivider">'+c.name+"</ons-list-item>");d.append(e);e.on("click",function(){getAndParseAccount(a,loadAcct)})});$("#menuList").append('<ons-list-item tappable id="acctMgr"><ons-icon icon="fa-user" size="18px"></ons-icon>&nbsp;&nbsp;Manage Accounts</ons-list-item>');$("#acctMgr").one("click",function(){$.getScript("accounts/accountManager.min.js",
function(){$("#acctMgr").click(goToAcctMgr);goToAcctMgr()})});getAndParseAccount(a?a:0,loadAcct,!0)}
function getAndParseAccount(a,d,b){currentAcctID=a;$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME);var c=!b,e=!1,g=!1;currentAcctData=null;var f;pop.hide();2<=navi.pages.length&&"mainPage"===navi.pages[navi.pages.length-2].name&&($("#iOSBackBtn").fadeOut(IOS_BTN_FADE_TIME),$("#title").text("Gradebook"));$(".fade").hide();"mainPage"!==navi.topPage.name&&c?navi.popPage({animation:"slide",animationOptions:{duration:TRANSITION_TIME}}).then(function(){g=!0;e&&(currentAcctData=f,d(f))}):(g=!0,$(".fade").hide());
$("#mainLoading").fadeIn(FADE_TIME);var h=accountMetadata[a],m=$.post(h.url+"skyporthttp.w",{requestAction:"eel",codeType:"tryLogin",login:h.login,password:h.password}).done(function(){if(-1<m.responseText.toLowerCase().indexOf("invalid login or password")||-1===m.responseText.toLowerCase().indexOf(h.login))displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't authenticate with the server. Please verify your credentials and try again.","ErrorCircle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,
function(){getAndParseAccount(a,d,b)})});else{var c=m.responseText.split("^");currentDWD=c[0].substr(4);currentWFAACL=c[3];currentStudentID=c[4];currentAcctURL=h.url;h.overrides&&(currentStudentID=h.overrides.studentID);var v=$.post(h.url+"gradebook.w",{dwd:currentDWD,wfaacl:currentWFAACL,currentStudent:currentStudentID}).done(function(){f={name:h.name,goal:h.goal,failing:h.failing,courses:[]};var b=$((new DOMParser).parseFromString(v.responseText,"text/html")),c=b.find(".myBox")[0];if(c){for(var c=
c.firstChild.children,q=1;100>q;){var r=b.find("#link"+q).find("#link"+q),m=$(r[0]);if(0>=r.length)break;else if("nonCurrentClass"!=m.parent().parent().parent().parent().parent().parent().parent().parent().parent().parent().parent().parent().parent().attr("id")){for(var k=c[q].children,r=-1,p,n,t,l=k.length-2;1<=l;l--){var u=$(k[l]);if(0<u.text().trim().length&&0<$(k[l-1]).text().trim().length){r=u.text().trim();p=$(c[0].children[l]);t=p.text();n=p.attr("id");k=/\d/.exec(n).index;p=n.substr(0,k);
n=n.substr(k,/\D/.exec(n.substr(k)).index);break}}k=m.children();l=k.eq(2).html();f.courses.push({name:k.eq(0).text().trim(),teacher:l.substring(l.indexOf(":")+2,l.indexOf("<br>")).trim(),grade:r,GBID:m.parent().parent().parent().parent().attr("onclick").split('"')[1].trim(),courseID:m.parent().parent().parent().parent().attr("onclick").split('"')[3].trim(),extType:p,extNum:n,termName:p+" "+t})}q++}e=!0;g&&(currentAcctData=f,d(f))}else b=b.find("#pageContentWrap").children().eq(1),0<b.length?displayErrorPage("#mainPageErrMsgDiv",
"Oh No!",b.text().trim(),"ErrorCircle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,!0)})}):displayErrorPage("#mainPageErrMsgDiv","Oh No!","An unexpected error has occurred. Please try again later","ErrorCircle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,!0)})})}).fail(function(c){0===c.readyState?displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't establish a connection. Please check your internet connection and try again.",
"ErrorTriangle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,b)})}):displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't retrieve your account information (HTTP "+c.status+"). Please try again later.","ErrorTriangle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,b)})})})}}).fail(function(c){0===c.readyState?displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't establish a connection. Please check your internet connection and try again.",
"ErrorTriangle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,b)})}):displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't send your credentials (HTTP "+c.status+"). Please try again later.","ErrorTriangle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,function(){getAndParseAccount(a,d,b)})})})}
function loadAcct(a){if(a){$("#goalText").text("Goal: "+(isNumber(a.goal)?a.goal:"Not Set"));$("#goal").off("click").one("click",promptForGoal);var d=0,b=0;$("#mainLoading, #mainPageErrMsgDiv").fadeOut(FADE_TIME);var c=$("#list");c.empty();c.append('<ons-list-header id="hamburgerHeader" modifier="material">'+a.name+"</ons-list-header>");$.each(a.courses,function(a,e){var f;0>e.grade?(f=$('<ons-list-item tappable modifier="chevron longdivider" class="course systemFont"><ons-col class="courseCol"><div class="courseName">'+
e.name+'</div><div class="courseGrade">There are no grades in this course</div><div class="courseTeacher">'+e.teacher+"</div></ons-col></ons-list-item>"),f.on("click",function(){alertMsg("There are currently no assignments in this course.")})):(isNumber(e.grade)&&(d+=+e.grade,b++),f=$('<ons-list-item tappable modifier="chevron longdivider" class="course systemFont"><ons-col class="courseCol"><div class="courseName">'+e.name+'</div><div class="courseGrade">Grade: '+e.grade+'</div><div class="courseTeacher">'+
e.teacher+"</div></ons-col></ons-list-item>"),f.on("click",function(){getAndParseCourse(e,loadGrades)}));c.append(f)});var e=$("#outerCircle"),g=.35*$(window).height();e.css("height",g);e.css("width",g);e.css("border-radius",g/2);var f=isNumber(a.goal)?a.goal:100;a=isNumber(a.failing)?a.failing:60;var h=ensureRange(Math.round(d/b),a,f);e.css("background",colorFromGrade(100/(f-a)*(h-a)));e=$("#innerCircle");e.empty();f=.6*g;e.css("height",f);e.css("width",f);e.css("border-radius",f/2);e.css("margin",
(g-f)/2+"px");a=f/1.75;0<b?(e.append('<div id="circleText">'+Math.round(d/b)+"</div>"),$("#circleText").css("margin-top",g/4-a/2.25)):(e.append('<div id="circleText">No Data</div>'),a=f/3,$("#circleText").css("margin-top","10px"));e.css("font-size",a+"px");$("#avgText").text("Average across all courses");$(".fade").fadeIn(1E3)}else $(".fade").hide(),displayErrorPage("#mainPageErrMsgDiv","Oh No!","We couldn't load this account. This might be caused by your internet connection.","ErrorCircle",function(){$("#mainPageErrMsgDiv").fadeOut(ERR_FADE_TIME,
function(){loadAcct(currentAcctData)})})};