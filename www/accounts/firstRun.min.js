var ss,movingLock=!1,PAGES=["greetings","district","login"],TRANSITION_TIME=.325,FADE_TIME=150,ERR_FADE_TIME=200,searchTimer,SEARCH_TYPING_TIMEOUT=1500,KEY_CODE_ENTER=13,accountMetadata,account={login:null,password:null,url:null,name:null};ons.forcePlatformStyling("android");
$(document).ready(function(){"windows"===cordova.platformId&&(window.onerror=function(){return!0});ons.ready(function(){$("#back").click(backPage);document.addEventListener("backbutton",function(){backPage(!0)});$("#next").click(advancePage);"android"===cordova.platformId.toLowerCase()&&$("head").prepend('<meta name="viewport" content="width=device-width,height='+window.innerHeight+', initial-scale=1.0">');ss=new cordova.plugins.SecureStorage(function(){console.info("Secure storage init complete!");
ss.get(function(a){accountMetadata=JSON.parse(a);console.info("Successfully retrieved metadata!")},function(a){console.error("Error: "+a);accountMetadata={accounts:[]}},"accountMetadata")},function(a){console.error("Error: "+a)},"scorescope")})});function alertMsg(a,b,c){ons.notification.alert({title:b,message:a,callback:c})}
function showFirstRunError(a,b,c,e){$("#FRErrTitle").text(a);$("#FRErrDetails").text(b);a=$("#FRErrRetryBtn");a.hide();"function"===typeof e&&(a.show(),a.unbind("click").on("click",e));c&&$("#FRErrIconSvg").attr("src","../lib/img/"+c+".svg");$("#loading").fadeOut(ERR_FADE_TIME,function(){$("#firstRunErrDiv").fadeIn(ERR_FADE_TIME)})}function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}
function backPage(a){a="boolean"!==typeof a;movingLock||($("#next").fadeIn(FADE_TIME),navi.topPage.name!==PAGES[0]&&(navi.topPage.name===PAGES[1]&&$("#back").fadeOut(FADE_TIME),a&&(movingLock=!0,navi.popPage({animation:"slide",animationOptions:{duration:TRANSITION_TIME}}).then(function(){movingLock=!1}))))}
function advancePage(){movingLock||(navi.topPage.name===PAGES[PAGES.length-1]&&tcCheckBox.checked?validateAndGo():($("#next").fadeOut(FADE_TIME),$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME),$("#back").fadeIn(FADE_TIME),movingLock=!0,navi.pushPage(PAGES[PAGES.indexOf(navi.topPage.name)+1],{animation:"slide",animationOptions:{duration:TRANSITION_TIME}}).then(function(){movingLock=!1;"district"===navi.topPage.name?($("#search").keyup(function(){$(".district, #firstRunErrDiv").fadeOut(ERR_FADE_TIME,function(){$("#list").empty()});
$("#next").fadeOut(FADE_TIME);clearTimeout(searchTimer);3>$("#search").val().trim().length||!$("#myInput").val||($("#loading").fadeIn(2*FADE_TIME),searchTimer=setTimeout(searchForDist,SEARCH_TYPING_TIMEOUT))}),$("#search").keypress(function(a){a.keyCode===KEY_CODE_ENTER&&(clearTimeout(searchTimer),$("#loading").fadeIn(FADE_TIME),searchForDist())})):"login"===navi.topPage.name&&($("#domain").text(account.districtName),$("#tc").click(function(){tcCheckBox.checked?$("#next").fadeIn(FADE_TIME):$("#next").fadeOut(FADE_TIME)}))})))}
function searchForDist(){function a(a,f){if("fromLoc"===f){var b=a.toJSON()["#document"]["soap:Envelope"]["soap:Body"].CompanyDistanceQueryAllResponse.CompanyDistanceQueryAllResult;if(""!=b)var d=b.CompanyDistanceInfo;else{showFirstRunError("No Results Found","We couldn't find any results matching your query.","NotFound",null);$("#loading").fadeOut(2*FADE_TIME);$("#next").fadeOut(FADE_TIME);return}}else if(b=a.toJSON()["#document"]["soap:Envelope"]["soap:Body"].CompanyNameQueryResponse.CompanyNameQueryResult,
""!=b)d=b.CompanyNameInfo;else{showFirstRunError("No Results Found","We couldn't find any results matching your query.","NotFound",null);$("#loading").fadeOut(2*FADE_TIME);$("#next").fadeOut(FADE_TIME);return}$("#loading").fadeOut(2*FADE_TIME,function(){var a=$("#list");Array.isArray(d)||(d=[d]);$.each(d,function(e,b){if("true"===b.allowStu){var d=$('<ons-list-item tappable class="district" modifier="longdivider"><ons-col class="distCol"><div class="distName">'+b.name+'</div><div class="distLoc">'+
b.city+" "+b.state+"</div></ons-col></ons-list-item>");a.append(d);d.on("click",function(){selectDistrict(b,e)})}else d=$('<ons-list-item tappable class="district" modifier="longdivider"><ons-col class="distCol"><div class="distName">'+b.name+'</div><div class="distLoc">'+b.city+" "+b.state+"</div></ons-col></ons-list-item>"),a.append(d),d.on("click",function(){confirmAllowStuOverride(b,e)})})})}var b=$("#search").val().trim();if("appreview124"===b.toLowerCase()){var c={name:"Test District",studentURL:"http://162.243.217.157:8085/testing/seplog01.w",
city:"Anycity",state:"Anystate"};$("#loading").fadeOut(FADE_TIME,function(){var a=$('<ons-list-item tappable class="district" modifier="longdivider"><ons-col class="distCol"><div class="distName">'+c.name+'</div><div class="distLoc">'+c.city+" "+c.state+"</div></ons-col></ons-list-item>");$("#list").append(a);a.on("click",function(){selectDistrict(c,0)})})}else isNumber(b)&&5===b.length?$.soap({url:"http://rms.skyward.com/rmswebservices/Company/GPSfromZip.asmx",method:"GetGPSfromZip",namespaceURL:"http://tempuri.org/",
appendMethodToURL:!1,soap12:!0,data:{zip:b},success:function(b){b=b.toJSON()["#document"]["soap:Envelope"]["soap:Body"].GetGPSfromZipResponse.GetGPSfromZipResult;""===b?showFirstRunError("Whoops!","It seems like that zip code is invalid. Please try another.","NotFound",null):(b=b.ZipGPSInfo,$.soap({url:"http://rms.skyward.com/rmswebservices/Company/AllCompanyByRadius.asmx",method:"CompanyDistanceQueryAll",namespaceURL:"http://tempuri.org/",appendMethodToURL:!1,soap12:!0,data:{latitudeHome:b.latitude,
longitudeHome:b.longitude,radiusMiles:"50"},success:function(b){a(b,"fromLoc")},error:function(a){console.error("SOAP Error: "+a);showFirstRunError("Oh No!","We couldn't search by zip code. Try searching by name.","ErrorCircle",null)}}).fail(function(a,b,d){console.error("Network Error: ",b,d);0===xhr.readyState?showFirstRunError("Oh No!","We couldn't establish a connection. Please check your internet connection and try again.","ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,
searchForDist)}):showFirstRunError("Oh No!","We couldn't connect to the server (HTTP "+a.status+"). Please try again later.","ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,searchForDist)})}))},error:function(a){console.error("SOAP Error: "+a);showFirstRunError("Oh No!","We couldn't search by zip code. Try searching by name.","ErrorCircle",null)}}).fail(function(a,b,c){console.error("Network Error: ",b,c);0===xhr.readyState?showFirstRunError("Oh No!","We couldn't establish a connection. Please check your internet connection and try again.",
"ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,searchForDist)}):showFirstRunError("Oh No!","We couldn't connect to the server (HTTP "+a.status+"). Please try again later.","ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,searchForDist)})}):0<b.length&&$.soap({url:"http://rms.skyward.com/rmswebservices/company/allcompanybyname.asmx",method:"CompanyNameQuery",namespaceURL:"http://tempuri.org/",appendMethodToURL:!1,soap12:!0,data:{companySearchString:b},success:function(b){a(b,
"fromName")},error:function(a){console.error("SOAP Error: "+a);showFirstRunError("Oh No!","We couldn't search by district name. Try searching by zip code.","ErrorCircle",null)}}).fail(function(a,b,c){console.error("Network Error: ",b,c);0===xhr.readyState?showFirstRunError("Oh No!","We couldn't establish a connection. Please check your internet connection and try again.","ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,searchForDist)}):showFirstRunError("Oh No!","We couldn't connect to the server (HTTP "+
a.status+"). Please try again later.","ErrorTriangle",function(){$("#firstRunErrDiv").fadeOut(ERR_FADE_TIME,searchForDist)})})}function selectDistrict(a,b){account.url=a.studentURL.substr(0,a.studentURL.lastIndexOf("/")+1);account.districtName=a.name;$(".district").removeClass("selectedDistrict");$(".district").eq(b).addClass("selectedDistrict");$("#next").fadeIn(FADE_TIME)}
function confirmAllowStuOverride(a,b){0<a.studentURL.length?ons.notification.confirm({message:"Your district administrator has not enabled mobile access. Some parts of ScoreScope may not function correctly. Would you like to continue anyways?",buttonLabels:["Yes","No"],primaryButtonIndex:0}).then(function(c){0===c&&selectDistrict(a,b)}):alertMsg("Your district administrator has not enabled mobile access. Please contact your district's Skyward administrator for more details.")}
function validateAndGo(){function a(a){var c=$.post(account.url+"skyporthttp.w",{requestAction:"eel",codeType:"tryLogin",login:account.login,password:account.password}).done(function(){var d=c.responseText.split("^");isNumber(d[6])&&1===+d[6]&&"undefined"===typeof account.overrides?b({dwd:d[0].substr(4),wfaacl:d[3]}):-1<c.responseText.toLowerCase().indexOf("invalid login or password")||-1===d[5].toLowerCase().indexOf(account.login)?(alertMsg("We couldn't validate your credentials. Please verify that your username and password are correct.",
"Error"),$("#pw").val("")):(accountMetadata.accounts.push($.extend(!0,{},account)),ss.set(function(a){console.info("Successfully saved "+a)},function(a){console.error("Error: "+a);alertMsg("Failed to save account information. Please try again.","Error")},"accountMetadata",JSON.stringify(accountMetadata)),"function"===typeof a&&a())}).fail(function(a){0===a.readyState?alertMsg("Please check your internet connection and try again.","Error"):alertMsg("We couldn't validate your account information. This may be a temporary server-side issue. Please try again later.",
"Error")})}function b(b){var c=$.post(account.url+"familyaccess.w",b).done(function(){function b(c){var f=e.find("#link"+c)[0];f?(account.overrides={studentID:$(f.firstChild.firstChild.firstChild.firstChild).attr("onclick").split('"')[3]},0<account.name.indexOf(" Child #")?account.name=account.name.substr(0,account.name.length-1)+(+account.name.charAt(account.name.length-1)+1):account.name+=" Child #"+c,a(function(){b(c+1)})):window.location.replace("../index.html")}var e=$((new DOMParser).parseFromString(c.responseText,
"text/html")).find(".myBox");1>e.length&&alertMsg("Unfortunately, the server sent a malformed response. Please try again.","Error");b(1)}).fail(function(a){0===a.readyState?alertMsg("Please check your internet connection and try again.","Error"):alertMsg("We couldn't validate your account information. This may be a temporary server-side issue. Please try again later.","Error")})}account.login=$("#user").val().trim().toLowerCase();account.password=$("#pw").val().trim();account.name=$("#name").val().trim();
if(0===account.name.length)alertMsg("Please enter a name for this account.");else{for(var c=!1,e=0;e<accountMetadata.accounts.length;e++)c||accountMetadata.accounts[e].login!==account.login.toLowerCase()||accountMetadata.accounts[e].url!==account.url||(c=!0,ons.notification.confirm({message:"You have already linked this Skyward\u00ae account to ScoreScope. Do you want to continue anyways?",buttonLabels:["Yes","No"],primaryButtonIndex:0}).then(function(b){0===b&&a(function(){window.location.replace("../index.html")})}));
c||a(function(){window.location.replace("../index.html")})}};